{% load static formatting %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ listing.title }} | Homnest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'app/css/header.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/chitietnoio.css' %}">
</head>
<body>
    {% include 'app/includes/header.html' %}

    <main class="container mt-4">
        <section class="gallery-container mb-4">
            <div class="gallery-grid">
                <div class="gallery-main">
                    {% with images|first as main_img %}
                        <img src="{{ main_img.image_url }}" class="object-fit-cover" alt="Main image">
                    {% endwith %}
                </div>
                <div class="gallery-thumbs">
                    {% for img in images|slice:"1:5" %}
                    <div class="gallery-thumb">
                        <img src="{{ img.image_url }}" class="object-fit-cover" alt="Thumbnail {{ forloop.counter }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% if images|length > 5 %}
            <button class="btn btn-light show-all-photos" data-bs-toggle="modal" data-bs-target="#galleryModal">
                <i class="fa-solid fa-images me-2"></i>Hiển thị tất cả {{ images|length }} ảnh
            </button>
            {% endif %}
        </section>

        <div class="row content-row">
            <div class="col-lg-8">
                <div class="listing-header border-bottom pb-4 mb-4">
                    <h1 class="fw-bold">{{ listing.title }}</h1>
                    {% if address %}
                    <p class="text-muted"><i class="fa-solid fa-location-dot me-2"></i>{{ address.street }}, {{ address.district }}, {{ address.city }}</p>
                    {% else %}
                    <p class="text-muted"><i class="fa-solid fa-location-dot me-2"></i>Chưa cập nhật địa chỉ</p>
                    {% endif %}
                    <div class="listing-badges">
                        <span class="badge bg-light text-dark border"><i class="fa-solid fa-user me-1"></i> Tối đa {{ listing.max_adults|add:listing.max_children }} khách</span>
                        <span class="badge bg-light text-dark border"><i class="fa-solid fa-star text-danger me-1"></i> {{ avg_rating|floatformat:1 }} ({{ review_count }} đánh giá)</span>
                    </div>
                </div>

                <!-- Mô tả chi tiết -->
                <div class="description-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3">Giới thiệu về chỗ ở</h4>
                    <p class="text-secondary" style="white-space: pre-line;">{{ listing.description }}</p>
                </div>

                <!-- Thông tin chi tiết -->
                <div class="details-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3">Chi tiết chỗ ở</h4>
                    <div class="row">
                        <!-- Loại chỗ ở -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-house text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Loại chỗ ở</small>
                                    <p class="mb-0 fw-semibold">{{ listing.property_type|default:"Nhà riêng" }}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Loại sử dụng -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-door-open text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Loại sử dụng</small>
                                    <p class="mb-0 fw-semibold">{{ listing.usage_type|default:"Toàn bộ nhà" }}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Số khách tối đa -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-users text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Số khách tối đa</small>
                                    <p class="mb-0 fw-semibold">{{ listing.max_adults }} người lớn{% if listing.max_children %}, {{ listing.max_children }} trẻ em{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Phòng ngủ -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-bed text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Phòng ngủ</small>
                                    <p class="mb-0 fw-semibold">{{ listing.bedrooms|default:1 }} phòng ngủ</p>
                                </div>
                            </div>
                        </div>
                        <!-- Giường -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-couch text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Giường</small>
                                    <p class="mb-0 fw-semibold">{{ listing.beds|default:1 }} giường</p>
                                </div>
                            </div>
                        </div>
                        <!-- Phòng tắm -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-bath text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Phòng tắm</small>
                                    <p class="mb-0 fw-semibold">{{ listing.bathrooms|default:1 }} phòng tắm</p>
                                </div>
                            </div>
                        </div>
                        <!-- Thú cưng -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-paw text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Thú cưng</small>
                                    <p class="mb-0 fw-semibold">{% if listing.max_pets > 0 %}Cho phép {{ listing.max_pets }} thú cưng{% else %}Không cho phép{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        {% if listing.available_from and listing.available_to %}
                        <!-- Thời gian cho thuê -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-calendar-check text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Thời gian cho thuê</small>
                                    <p class="mb-0 fw-semibold">{{ listing.available_from|date:"d/m/Y" }} - {{ listing.available_to|date:"d/m/Y" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Tiện nghi cơ bản và nổi bật -->
                <div class="amenities-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3">Những gì nơi này có</h4>
                    <div class="row">
                        {% for amenity in basic_amenities %}
                        <div class="col-md-6 mb-2">
                            <i class="{{ amenity.icon|default:'fa-solid fa-check' }} text-success me-2"></i> {{ amenity.name }}
                        </div>
                        {% endfor %}
                        {% for amenity in featured_amenities %}
                        <div class="col-md-6 mb-2">
                            <i class="{{ amenity.icon|default:'fa-solid fa-star' }} text-warning me-2"></i> {{ amenity.name }}
                        </div>
                        {% endfor %}
                        {% if not basic_amenities and not featured_amenities %}
                        <p class="text-muted">Chưa cập nhật tiện nghi.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Thông tin an toàn -->
                {% if safety_amenities %}
                <div class="safety-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3"><i class="fa-solid fa-shield-halved me-2"></i>Thông tin an toàn</h4>
                    <div class="row">
                        {% for amenity in safety_amenities %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="{{ amenity.icon|default:'fa-solid fa-shield-halved' }} text-warning me-2 fs-5"></i>
                                <span>{{ amenity.name }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Nơi bạn sẽ đến -->
                <div class="map-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3"><i class="fa-solid fa-map-location-dot me-2"></i>Nơi bạn sẽ đến</h4>
                    {% if address %}
                    <div class="location-address mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fa-solid fa-location-dot text-danger me-3 mt-1 fs-5"></i>
                            <div>
                                <p class="mb-1 fw-semibold">{{ address.district }}, {{ address.city }}</p>
                                <p class="text-muted mb-0 small">{{ address.street }}, {{ address.district }}, {{ address.city }}</p>
                            </div>
                        </div>
                    </div>
                    <div id="listing-map" class="listing-map-container"></div>
                    <p class="text-muted small mt-2"><i class="fa-solid fa-info-circle me-1"></i>Địa chỉ chính xác sẽ được cung cấp sau khi bạn đặt phòng thành công.</p>
                    {% else %}
                    <p class="text-muted">Chưa cập nhật vị trí.</p>
                    {% endif %}
                </div>

                <div class="host-section p-4 bg-light rounded-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <img src="{{ host_avatar_url }}" class="rounded-circle me-3" width="60" height="60" alt="Host">
                        <div>
                            <h5 class="fw-bold mb-0">Chủ nhà: {{ host.full_name|default:host.username }}</h5>
                            <p class="text-muted mb-0">Tham gia từ {{ host.date_joined|date:"m/Y" }}</p>
                        </div>
                    </div>
                    <p class="mb-2"><strong>Thông tin liên hệ:</strong></p>
                    <p class="mb-1"><i class="fa-solid fa-phone me-2"></i> {{ host.phone_number|default:"Chưa cập nhật" }}</p>
                    <p><i class="fa-solid fa-envelope me-2"></i> {{ host.email }}</p>
                    {% if user.is_authenticated and user != host %}
                    <button class="btn btn-outline-dark btn-sm" onclick="openChatWithHost({{ listing.listing_id }})">Nhắn tin cho chủ nhà</button>
                    {% elif not user.is_authenticated %}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-outline-dark btn-sm">Nhắn tin cho chủ nhà</a>
                    {% endif %}
                </div>

                <div class="reviews-section">
                    <h4 class="fw-bold mb-4"><i class="fa-solid fa-star text-danger me-2"></i>{{ avg_rating|floatformat:1 }} · {{ review_count }} đánh giá</h4>
                    
                    <!-- Thống kê đánh giá tích cực / tiêu cực -->
                    <div class="d-flex gap-3 mb-4">
                        <span class="badge rounded-pill bg-success px-3 py-2">
                            <i class="fa-solid fa-face-smile me-1"></i> {{ positive_count|default:0 }} tích cực
                        </span>
                        <span class="badge rounded-pill bg-danger px-3 py-2">
                            <i class="fa-solid fa-face-frown me-1"></i> {{ negative_count|default:0 }} tiêu cực
                        </span>
                    </div>
                    
                    <!-- Form đánh giá cho khách đã ở -->
                    {% if can_review %}
                    <div class="review-form-section bg-light p-4 rounded-4 mb-4">
                        <h5 class="fw-bold mb-3"><i class="fa-solid fa-pen me-2"></i>Viết đánh giá của bạn</h5>

                        <form method="POST" enctype="multipart/form-data">{% csrf_token %}

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Điểm đánh giá</label>
                                <div class="rating-input">
                                    {% for i in "54321" %}
                                    <input type="radio" name="rating" id="star{{ i }}" value="{{ i }}" {% if forloop.first %}checked{% endif %}>
                                    <label for="star{{ i }}" title="{{ i }} sao"><i class="fa-solid fa-star"></i></label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">Nhận xét của bạn</label>
                                <textarea name="comment" class="form-control" rows="4" placeholder="Chia sẻ trải nghiệm của bạn về chỗ ở này..." required></textarea>
                            </div>
                            <label>Ảnh / Video (tuỳ chọn)</label>
                            <input 
                                type="file"
                                name="media"
                                multiple
                                accept="image/*,video/*"
                            >
                            <button type="submit" class="btn btn-danger">
                                <i class="fa-solid fa-paper-plane me-2"></i>Gửi đánh giá
                            </button>
                        </form>
                    </div>
                    {% elif review_status == 'reviewed' %}
                    <div class="alert alert-success">
                        <i class="fa-solid fa-check-circle me-2"></i>Bạn đã đánh giá chỗ ở này. Cảm ơn bạn!
                    </div>
                    {% endif %}

                    <!-- Danh sách đánh giá -->
                    {% for r in reviews %}
                    <div class="review-item mb-4 pb-3 border-bottom">
                        <div class="d-flex justify-content-between">
                            <div class="d-flex align-items-center">
                                <div>
                                    <h6 class="fw-bold mb-0">{{ r.user.full_name|default:r.user.username }}</h6>
                                    <small class="text-muted">{{ r.created_at|date:"d/m/Y" }}</small>
                                </div>
                            </div>
                        </div>
                        <div class="stars my-2">
                            {% for i in "12345" %}
                                <i class="fa-solid fa-star {% if forloop.counter <= r.rating %}text-warning{% else %}text-secondary{% endif %}" style="font-size: 14px;"></i>
                            {% endfor %}
                        </div>
                        <p class="mb-2">{{ r.comment }}</p>
                        {% for m in r.media.all %}
                            {% if m.media_type == "image" %}
                                <img src="{{ m.media.url }}" style="max-width:120px; border-radius:8px; margin-right:6px;">
                            {% elif m.media_type == "video" %}
                                <video src="{{ m.media.url }}" controls style="max-width:200px; border-radius:8px;"></video>
                            {% endif %}
                        {% endfor %}
                        {% if r.analysis %}
                        <div class="ai-analysis">
                            {% if r.analysis.sentiment == 'pos' or r.analysis.sentiment == 'positive' %}
                                <span class="badge rounded-pill bg-success text-white">Tích cực</span>
                            {% elif r.analysis.sentiment == 'neg' or r.analysis.sentiment == 'negative' %}
                                <span class="badge rounded-pill bg-danger text-white">Tiêu cực</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-muted text-center py-4">
                        <i class="fa-regular fa-comment-dots fa-2x mb-2 d-block"></i>
                        Chưa có đánh giá nào cho chỗ ở này.
                    </p>
                    {% endfor %}
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-lg p-4 booking-card" style="border-radius: 16px;">
                    <div class="price-header mb-3">
                        <span class="fs-3 fw-bold">₫{{ listing.price_per_night|floatformat:0|intdot }}</span> <span class="text-muted">/ đêm</span>
                    </div>

                    {% if listing.available_from and listing.available_to %}
                    <div class="alert alert-info py-2 px-3 mb-3" style="font-size: 13px; border-radius: 8px;">
                        <i class="fa-solid fa-calendar-check me-1"></i>
                        <strong>Thời gian cho thuê:</strong> {{ listing.available_from|date:"d/m/Y" }} - {{ listing.available_to|date:"d/m/Y" }}
                    </div>
                    {% endif %}

                    {% if messages %}
                    <div class="alert alert-warning py-2 px-3 mb-3" style="font-size: 13px; border-radius: 8px;">
                        {% for message in messages %}
                        <div>{{ message }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form action="{% url 'datphong' %}" method="GET">
                        <input type="hidden" name="room" value="{{ listing.listing_id }}">
                        <div class="booking-inputs border rounded-3 mb-3">
                            <div class="row g-0">
                                <div class="col-6 border-end p-2">
                                    <label class="small fw-bold text-uppercase">Nhận phòng</label>
                                    <input type="date" name="checkin" id="id_checkin" class="form-control border-0 p-0 shadow-none" required>
                                </div>
                                <div class="col-6 p-2">
                                    <label class="small fw-bold text-uppercase">Trả phòng</label>
                                    <input type="date" name="checkout" id="id_checkout" class="form-control border-0 p-0 shadow-none" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold py-3 mb-3" style="background-color: #ff385c;">
                            Kiểm tra tình trạng
                        </button>
                    </form>

                    <div id="price-calculation" class="mt-3 d-none">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-decoration-underline">&#8363;{{ listing.price_per_night|floatformat:0|intdot }} x <span id="nights-count">0</span> &#273;&#234;m</span>
                            <span id="base-price">&#8363;0</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>T&#7893;ng c&#7897;ng</span>
                            <span id="total-price">&#8363;0</span>
                        </div>
                    </div>
</div>
                </div>
            </div>
        </div>
    </main>

    {% include 'app/includes/footer.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const price = {{ listing.price_per_night|default:0 }};
            const listingId = {{ listing.listing_id|default:0 }};
            const checkin = document.getElementById('id_checkin');
            const checkout = document.getElementById('id_checkout');
            const calcDiv = document.getElementById('price-calculation');

            // Thời gian cho thuê từ listing
            const availableFrom = "{{ listing.available_from|date:'Y-m-d'|default:'' }}";
            const availableTo = "{{ listing.available_to|date:'Y-m-d'|default:'' }}";
            
            // Set min/max date based on rental period
            const today = new Date().toISOString().split('T')[0];
            
            // Min date: không được chọn ngày trong quá khứ, và không được trước available_from
            let minDate = today;
            if (availableFrom && availableFrom > today) {
                minDate = availableFrom;
            }
            
            // Max date: không được sau available_to
            let maxDate = availableTo || '';
            
            checkin.setAttribute('min', minDate);
            checkout.setAttribute('min', minDate);
            
            if (maxDate) {
                checkin.setAttribute('max', maxDate);
                checkout.setAttribute('max', maxDate);
            }

            function updatePrice() {
                if (checkin.value && checkout.value) {
                    const start = new Date(checkin.value);
                    const end = new Date(checkout.value);
                    const diff = (end - start) / (1000 * 60 * 60 * 24);

                    if (diff <= 0) {
                        calcDiv.classList.add('d-none');
                        return;
                    }

                    const url = `/api/price/?listing=${listingId}&checkin=${checkin.value}&checkout=${checkout.value}&guests=1`;
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            const nights = Number(data.nights || diff);
                            const base = Number(data.base || 0);
                            const total = Number(data.total || data.base || 0);

                            document.getElementById('nights-count').innerText = nights;
                            document.getElementById('base-price').innerText = '\u20ab' + base.toLocaleString('vi-VN');
                            document.getElementById('total-price').innerText = '\u20ab' + Math.round(total).toLocaleString('vi-VN');
                            calcDiv.classList.remove('d-none');
                        })
                        .catch(() => {
                            const base = diff * price;
                            document.getElementById('nights-count').innerText = diff;
                            document.getElementById('base-price').innerText = '\u20ab' + base.toLocaleString('vi-VN');
                            document.getElementById('total-price').innerText = '\u20ab' + Math.round(base).toLocaleString('vi-VN');
                            calcDiv.classList.remove('d-none');
                        });
                }
            }
            
            checkin.addEventListener('change', function() {
                if (checkin.value) {
                    // Checkout min phải sau checkin
                    checkout.setAttribute('min', checkin.value);
                    // Nhưng vẫn không được vượt quá available_to
                    if (maxDate) {
                        checkout.setAttribute('max', maxDate);
                    }
                }
                updatePrice();
            });
            checkout.addEventListener('change', updatePrice);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{% static 'app/js/header.js' %}"></script>
    
    <!-- Menu dropdown fix for chitietnoio -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.querySelector('.ab-icon[aria-label="Menu"]');
            const menuDropdown = document.getElementById('menuDropdown');
            
            if (menuBtn && menuDropdown) {
                menuBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menuDropdown.classList.toggle('active');
                };
                
                document.addEventListener('click', function(e) {
                    if (!menuDropdown.contains(e.target) && !menuBtn.contains(e.target)) {
                        menuDropdown.classList.remove('active');
                    }
                });
            }
        });
    </script>
    
    <!-- Map initialization -->
    {% if address %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get coordinates from address
            const addressStreet = "{{ address.street|escapejs }}";
            const addressDistrict = "{{ address.district|escapejs }}";
            const addressCity = "{{ address.city|escapejs }}";
            const fullAddress = `${addressStreet}, ${addressDistrict}, ${addressCity}, Vietnam`;
            
            // Check if we have coordinates stored
            const storedLat = {{ address.latitude|default:"null"|safe }};
            const storedLng = {{ address.longitude|default:"null"|safe }};
            
            // Initialize map
            const mapContainer = document.getElementById('listing-map');
            if (!mapContainer) return;
            
            let map;
            
            function initMapWithCoords(lat, lng) {
                map = L.map('listing-map').setView([lat, lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                
                // Custom icon
                const customIcon = L.divIcon({
                    className: 'custom-map-marker',
                    html: '<div style="background: #8B4513; width: 40px; height: 40px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fa-solid fa-home" style="transform: rotate(45deg); color: white; font-size: 16px;"></i></div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });
                
                L.marker([lat, lng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`<strong>{{ listing.title|escapejs }}</strong><br>${fullAddress}`)
                    .openPopup();
            }
            
            // If we have stored coordinates, use them
            if (storedLat && storedLng) {
                initMapWithCoords(storedLat, storedLng);
            } else {
                // Otherwise, geocode the address
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            initMapWithCoords(lat, lng);
                        } else {
                            // Fallback: try with just district and city
                            const simpleAddress = `${addressDistrict}, ${addressCity}, Vietnam`;
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(simpleAddress)}&limit=1`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data && data.length > 0) {
                                        const lat = parseFloat(data[0].lat);
                                        const lng = parseFloat(data[0].lon);
                                        initMapWithCoords(lat, lng);
                                    } else {
                                        // Default to Ho Chi Minh City center
                                        initMapWithCoords(10.8231, 106.6297);
                                    }
                                });
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        // Default to Ho Chi Minh City center
                        initMapWithCoords(10.8231, 106.6297);
                    });
            }
        });
    </script>
    {% endif %}
    
    {% include 'app/includes/chat_widget.html' %}
    
    <script>
    function openChatWithHost(listingId) {
        fetch(`/chat/open-listing/${listingId}/`, {
            method: 'GET',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(data => {
                    throw new Error(data.error || 'Không thể mở chat');
                });
            }
            return res.json();
        })
        .then(data => {
            openChat(data.conversation_id, data.other_user_name);
        })
        .catch(err => {
            console.error(err);
            alert(err.message || 'Không mở được chat');
        });
    }
    </script>
</body>
</html>
