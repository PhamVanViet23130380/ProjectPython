{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ listing.title }} | Homnest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'app/css/header.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/chitietnoio.css' %}">
</head>
<body>
    {% include 'app/includes/header.html' %}

    <main class="container mt-4">
        <section class="gallery-container mb-4">
            <div class="gallery-grid">
                <div class="gallery-main">
                    {% with images|first as main_img %}
                        <img src="{{ main_img.image_url }}" class="object-fit-cover" alt="Main image">
                    {% endwith %}
                </div>
                <div class="gallery-thumbs">
                    {% for img in images|slice:"1:5" %}
                    <div class="gallery-thumb">
                        <img src="{{ img.image_url }}" class="object-fit-cover" alt="Thumbnail {{ forloop.counter }}">
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% if images|length > 5 %}
            <button class="btn btn-light show-all-photos" data-bs-toggle="modal" data-bs-target="#galleryModal">
                <i class="fa-solid fa-images me-2"></i>Hi·ªÉn th·ªã t·∫•t c·∫£ {{ images|length }} ·∫£nh
            </button>
            {% endif %}
        </section>

        <div class="row content-row">
            <div class="col-lg-8">
                <div class="listing-header border-bottom pb-4 mb-4">
                    <h1 class="fw-bold">{{ listing.title }}</h1>
                    {% if address %}
                    <p class="text-muted"><i class="fa-solid fa-location-dot me-2"></i>{{ address.street }}, {{ address.district }}, {{ address.city }}</p>
                    {% else %}
                    <p class="text-muted"><i class="fa-solid fa-location-dot me-2"></i>Ch∆∞a c·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ</p>
                    {% endif %}
                    <div class="listing-badges">
                        <span class="badge bg-light text-dark border"><i class="fa-solid fa-user me-1"></i> T·ªëi ƒëa {{ listing.max_adults|add:listing.max_children }} kh√°ch</span>
                        <span class="badge bg-light text-dark border"><i class="fa-solid fa-star text-danger me-1"></i> {{ avg_rating|floatformat:1 }} ({{ review_count }} ƒë√°nh gi√°)</span>
                    </div>
                </div>

                <!-- M√¥ t·∫£ chi ti·∫øt -->
                <div class="description-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3">Gi·ªõi thi·ªáu v·ªÅ ch·ªó ·ªü</h4>
                    <p class="text-secondary" style="white-space: pre-line;">{{ listing.description }}</p>
                </div>

                <!-- Th√¥ng tin chi ti·∫øt -->
                <div class="details-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3">Chi ti·∫øt ch·ªó ·ªü</h4>
                    <div class="row">
                        <!-- Lo·∫°i ch·ªó ·ªü -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-house text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Lo·∫°i ch·ªó ·ªü</small>
                                    <p class="mb-0 fw-semibold">{{ listing.property_type|default:"Nh√† ri√™ng" }}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Lo·∫°i s·ª≠ d·ª•ng -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-door-open text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Lo·∫°i s·ª≠ d·ª•ng</small>
                                    <p class="mb-0 fw-semibold">{{ listing.usage_type|default:"To√†n b·ªô nh√†" }}</p>
                                </div>
                            </div>
                        </div>
                        <!-- S·ªë kh√°ch t·ªëi ƒëa -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-users text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">S·ªë kh√°ch t·ªëi ƒëa</small>
                                    <p class="mb-0 fw-semibold">{{ listing.max_adults }} ng∆∞·ªùi l·ªõn{% if listing.max_children %}, {{ listing.max_children }} tr·∫ª em{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Ph√≤ng ng·ªß -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-bed text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Ph√≤ng ng·ªß</small>
                                    <p class="mb-0 fw-semibold">{{ listing.bedrooms|default:1 }} ph√≤ng ng·ªß</p>
                                </div>
                            </div>
                        </div>
                        <!-- Gi∆∞·ªùng -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-couch text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Gi∆∞·ªùng</small>
                                    <p class="mb-0 fw-semibold">{{ listing.beds|default:1 }} gi∆∞·ªùng</p>
                                </div>
                            </div>
                        </div>
                        <!-- Ph√≤ng t·∫Øm -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-bath text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Ph√≤ng t·∫Øm</small>
                                    <p class="mb-0 fw-semibold">{{ listing.bathrooms|default:1 }} ph√≤ng t·∫Øm</p>
                                </div>
                            </div>
                        </div>
                        <!-- Th√∫ c∆∞ng -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-paw text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Th√∫ c∆∞ng</small>
                                    <p class="mb-0 fw-semibold">{% if listing.max_pets > 0 %}Cho ph√©p {{ listing.max_pets }} th√∫ c∆∞ng{% else %}Kh√¥ng cho ph√©p{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        <!-- Ph√≠ v·ªá sinh -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-broom text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Ph√≠ v·ªá sinh</small>
                                    <p class="mb-0 fw-semibold">‚Ç´{{ listing.cleaning_fee|floatformat:0 }}</p>
                                </div>
                            </div>
                        </div>
                        {% if listing.available_from and listing.available_to %}
                        <!-- Th·ªùi gian cho thu√™ -->
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fa-solid fa-calendar-check text-primary me-3 fs-4"></i>
                                <div>
                                    <small class="text-muted">Th·ªùi gian cho thu√™</small>
                                    <p class="mb-0 fw-semibold">{{ listing.available_from|date:"d/m/Y" }} - {{ listing.available_to|date:"d/m/Y" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Ti·ªán nghi c∆° b·∫£n v√† n·ªïi b·∫≠t -->
                <div class="amenities-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3">Nh·ªØng g√¨ n∆°i n√†y c√≥</h4>
                    <div class="row">
                        {% for amenity in basic_amenities %}
                        <div class="col-md-6 mb-2">
                            <i class="{{ amenity.icon|default:'fa-solid fa-check' }} text-success me-2"></i> {{ amenity.name }}
                        </div>
                        {% endfor %}
                        {% for amenity in featured_amenities %}
                        <div class="col-md-6 mb-2">
                            <i class="{{ amenity.icon|default:'fa-solid fa-star' }} text-warning me-2"></i> {{ amenity.name }}
                        </div>
                        {% endfor %}
                        {% if not basic_amenities and not featured_amenities %}
                        <p class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t ti·ªán nghi.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Th√¥ng tin an to√†n -->
                {% if safety_amenities %}
                <div class="safety-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3"><i class="fa-solid fa-shield-halved me-2"></i>Th√¥ng tin an to√†n</h4>
                    <div class="row">
                        {% for amenity in safety_amenities %}
                        <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center">
                                <i class="{{ amenity.icon|default:'fa-solid fa-shield-halved' }} text-warning me-2 fs-5"></i>
                                <span>{{ amenity.name }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- N∆°i b·∫°n s·∫Ω ƒë·∫øn -->
                <div class="map-section border-bottom pb-4 mb-4">
                    <h4 class="fw-bold mb-3"><i class="fa-solid fa-map-location-dot me-2"></i>N∆°i b·∫°n s·∫Ω ƒë·∫øn</h4>
                    {% if address %}
                    <div class="location-address mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fa-solid fa-location-dot text-danger me-3 mt-1 fs-5"></i>
                            <div>
                                <p class="mb-1 fw-semibold">{{ address.district }}, {{ address.city }}</p>
                                <p class="text-muted mb-0 small">{{ address.street }}, {{ address.district }}, {{ address.city }}</p>
                            </div>
                        </div>
                    </div>
                    <div id="listing-map" class="listing-map-container"></div>
                    <p class="text-muted small mt-2"><i class="fa-solid fa-info-circle me-1"></i>ƒê·ªãa ch·ªâ ch√≠nh x√°c s·∫Ω ƒë∆∞·ª£c cung c·∫•p sau khi b·∫°n ƒë·∫∑t ph√≤ng th√†nh c√¥ng.</p>
                    {% else %}
                    <p class="text-muted">Ch∆∞a c·∫≠p nh·∫≠t v·ªã tr√≠.</p>
                    {% endif %}
                </div>

                <div class="host-section p-4 bg-light rounded-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <img src="{{ host_avatar_url }}" class="rounded-circle me-3" width="60" height="60" alt="Host">
                        <div>
                            <h5 class="fw-bold mb-0">Ch·ªß nh√†: {{ host.full_name|default:host.username }}</h5>
                            <p class="text-muted mb-0">Tham gia t·ª´ {{ host.date_joined|date:"m/Y" }}</p>
                        </div>
                    </div>
                    <p class="mb-2"><strong>Th√¥ng tin li√™n h·ªá:</strong></p>
                    <p class="mb-1"><i class="fa-solid fa-phone me-2"></i> {{ host.phone_number|default:"Ch∆∞a c·∫≠p nh·∫≠t" }}</p>
                    <p><i class="fa-solid fa-envelope me-2"></i> {{ host.email }}</p>
                    <button class="btn btn-outline-dark btn-sm">Nh·∫Øn tin cho ch·ªß nh√†</button>
                </div>

                <!-- Reviews Section -->
                <section class="mb-5 pb-5 border-bottom">
                    {% if review_status == "pending_review" %}
                    <div class="alert alert-warning mb-4">
                        <strong>üü° B·∫°n ƒë√£ ·ªü xong ch·ªó n√†y</strong><br>
                        H√£y ƒë·ªÉ l·∫°i ƒë√°nh gi√° ƒë·ªÉ gi√∫p nh·ªØng kh√°ch kh√°c nh√©!
                    </div>
                    {% elif review_status == "reviewed" %}
                    <div class="alert alert-success mb-4">
                        ‚úÖ B·∫°n ƒë√£ ƒë√°nh gi√° ch·ªó ·ªü n√†y
                    </div>
                    {% endif %}

                    <h2 class="h5 fw-bold mb-4">
                        <i class="fa-solid fa-star" style="color: #ff385c;"></i>
                        {{ avg_rating|floatformat:1 }} ¬∑ {{ reviews|length }} ƒë√°nh gi√°
                    </h2>
                    
                    {% for r in reviews %}
                    <div class="mb-4">
                        <div class="d-flex align-items-start mb-3">
                            <img src="{{ r.user_avatar_url }}" class="rounded-circle me-3" width="48" height="48" alt="{{ r.user.username }}">
                            
                            <div class="flex-grow-1">
                                <p class="fw-bold mb-1">{{ r.user.get_full_name|default:r.user.username }}</p>
                                <p class="text-muted small mb-2">{{ r.created_at|date:"m/Y" }}</p>
                                <div class="mb-1">
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= r.rating %}
                                            <i class="fa-solid fa-star" style="color:#FFD700;font-size:12px;"></i>
                                        {% else %}
                                            <i class="fa-regular fa-star" style="color:#E0E0E0;font-size:12px;"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <p class="mb-0">{{ r.comment }}</p>

                                {% if r.analysis %}
                                    <div class="mt-1">
                                        {% if r.analysis.sentiment == "positive" %}
                                            <span class="badge bg-success">T√≠ch c·ª±c</span>
                                        {% elif r.analysis.sentiment == "negative" %}
                                            <span class="badge bg-danger">Ti√™u c·ª±c</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Trung t√≠nh</span>
                                        {% endif %}
                                        <small class="text-muted ms-1">
                                        (AI {{ r.analysis.confidence_score }})
                                        </small>
                                    </div>
                                {% endif %}

                            </div>
                        </div>
                    </div>
                    {% empty %}
                        <p class="text-muted">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho ph√≤ng n√†y.</p>
                    {% endfor %}
                </section>
                {% if can_review %}
                <section class="mb-5 pb-5 border-bottom">
                    <h4 class="fw-bold mb-3">ƒê√°nh gi√° c·ªßa b·∫°n</h4>

                    <form method="post">
                        {% csrf_token %}

                        <div class="mb-3">
                            <label class="form-label fw-bold">S·ªë sao</label>
                            <select name="rating" class="form-select" required>
                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê R·∫•t t·ªët</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê T·ªët</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê B√¨nh th∆∞·ªùng</option>
                                <option value="2">‚≠ê‚≠ê T·ªá</option>
                                <option value="1">‚≠ê R·∫•t t·ªá</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Nh·∫≠n x√©t</label>
                            <textarea
                                name="comment"
                                class="form-control"
                                rows="4"
                                placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n..."
                                required></textarea>
                        </div>

                        <button class="btn btn-danger fw-bold">
                            G·ª≠i ƒë√°nh gi√°
                        </button>
                    </form>
                </section>
                {% endif %}
            </div>

            <div class="col-lg-4">
                <div class="card shadow-lg p-4 booking-card" style="border-radius: 16px;">
                    <div class="price-header mb-3">
                        <span class="fs-3 fw-bold">‚Ç´{{ listing.price_per_night|floatformat:0 }}</span> <span class="text-muted">/ ƒë√™m</span>
                    </div>

                    {% if listing.available_from and listing.available_to %}
                    <div class="alert alert-info py-2 px-3 mb-3" style="font-size: 13px; border-radius: 8px;">
                        <i class="fa-solid fa-calendar-check me-1"></i>
                        <strong>Th·ªùi gian cho thu√™:</strong> {{ listing.available_from|date:"d/m/Y" }} - {{ listing.available_to|date:"d/m/Y" }}
                    </div>
                    {% endif %}

                    <form action="{% url 'create_and_pay' listing.listing_id %}" method="POST">
                        {% csrf_token %}
                        <div class="booking-inputs border rounded-3 mb-3">
                            <div class="row g-0">
                                <div class="col-6 border-end p-2">
                                    <label class="small fw-bold text-uppercase">Nh·∫≠n ph√≤ng</label>
                                    <input type="date" name="checkin" id="id_checkin" class="form-control border-0 p-0 shadow-none" required>
                                </div>
                                <div class="col-6 p-2">
                                    <label class="small fw-bold text-uppercase">Tr·∫£ ph√≤ng</label>
                                    <input type="date" name="checkout" id="id_checkout" class="form-control border-0 p-0 shadow-none" required>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-danger w-100 fw-bold py-3 mb-3" style="background-color: #ff385c;">
                            Ki·ªÉm tra t√¨nh tr·∫°ng
                        </button>
                    </form>

                    <div id="price-calculation" class="mt-3 d-none">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-decoration-underline">‚Ç´{{ listing.price_per_night|floatformat:0 }} x <span id="nights-count">0</span> ƒë√™m</span>
                            <span id="base-price">‚Ç´0</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-decoration-underline">Ph√≠ d·ªçn d·∫πp</span>
                            <span>‚Ç´{{ listing.cleaning_fee|floatformat:0 }}</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between fw-bold fs-5">
                            <span>T·ªïng c·ªông</span>
                            <span id="total-price">‚Ç´0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    {% include 'app/includes/footer.html' %}

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const price = {{ listing.price_per_night }};
            const cleaningFee = {{ listing.cleaning_fee|default:0 }};
            const checkin = document.getElementById('id_checkin');
            const checkout = document.getElementById('id_checkout');
            const calcDiv = document.getElementById('price-calculation');

            // Th·ªùi gian cho thu√™ t·ª´ listing
            const availableFrom = "{{ listing.available_from|date:'Y-m-d'|default:'' }}";
            const availableTo = "{{ listing.available_to|date:'Y-m-d'|default:'' }}";
            
            // Set min/max date based on rental period
            const today = new Date().toISOString().split('T')[0];
            
            // Min date: kh√¥ng ƒë∆∞·ª£c ch·ªçn ng√†y trong qu√° kh·ª©, v√† kh√¥ng ƒë∆∞·ª£c tr∆∞·ªõc available_from
            let minDate = today;
            if (availableFrom && availableFrom > today) {
                minDate = availableFrom;
            }
            
            // Max date: kh√¥ng ƒë∆∞·ª£c sau available_to
            let maxDate = availableTo || '';
            
            checkin.setAttribute('min', minDate);
            checkout.setAttribute('min', minDate);
            
            if (maxDate) {
                checkin.setAttribute('max', maxDate);
                checkout.setAttribute('max', maxDate);
            }

            function updatePrice() {
                if (checkin.value && checkout.value) {
                    const start = new Date(checkin.value);
                    const end = new Date(checkout.value);
                    const diff = (end - start) / (1000 * 60 * 60 * 24);

                    if (diff > 0) {
                        const base = diff * price;
                        const total = base + cleaningFee;
                        document.getElementById('nights-count').innerText = diff;
                        document.getElementById('base-price').innerText = '‚Ç´' + base.toLocaleString('vi-VN');
                        document.getElementById('total-price').innerText = '‚Ç´' + Math.round(total).toLocaleString('vi-VN');
                        calcDiv.classList.remove('d-none');
                    } else {
                        calcDiv.classList.add('d-none');
                    }
                }
            }
            
            checkin.addEventListener('change', function() {
                if (checkin.value) {
                    // Checkout min ph·∫£i sau checkin
                    checkout.setAttribute('min', checkin.value);
                    // Nh∆∞ng v·∫´n kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° available_to
                    if (maxDate) {
                        checkout.setAttribute('max', maxDate);
                    }
                }
                updatePrice();
            });
            checkout.addEventListener('change', updatePrice);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="{% static 'app/js/header.js' %}"></script>
    
    <!-- Map initialization -->
    {% if address %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get coordinates from address
            const addressStreet = "{{ address.street|escapejs }}";
            const addressDistrict = "{{ address.district|escapejs }}";
            const addressCity = "{{ address.city|escapejs }}";
            const fullAddress = `${addressStreet}, ${addressDistrict}, ${addressCity}, Vietnam`;
            
            // Check if we have coordinates stored
            const storedLat = {{ address.latitude|default:"null" }};
            const storedLng = {{ address.longitude|default:"null" }};
            
            // Initialize map
            const mapContainer = document.getElementById('listing-map');
            if (!mapContainer) return;
            
            let map;
            
            function initMapWithCoords(lat, lng) {
                map = L.map('listing-map').setView([lat, lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);
                
                // Custom icon
                const customIcon = L.divIcon({
                    className: 'custom-map-marker',
                    html: '<div style="background: #8B4513; width: 40px; height: 40px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fa-solid fa-home" style="transform: rotate(45deg); color: white; font-size: 16px;"></i></div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                });
                
                L.marker([lat, lng], { icon: customIcon })
                    .addTo(map)
                    .bindPopup(`<strong>{{ listing.title|escapejs }}</strong><br>${fullAddress}`)
                    .openPopup();
            }
            
            // If we have stored coordinates, use them
            if (storedLat && storedLng) {
                initMapWithCoords(storedLat, storedLng);
            } else {
                // Otherwise, geocode the address
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            initMapWithCoords(lat, lng);
                        } else {
                            // Fallback: try with just district and city
                            const simpleAddress = `${addressDistrict}, ${addressCity}, Vietnam`;
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(simpleAddress)}&limit=1`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data && data.length > 0) {
                                        const lat = parseFloat(data[0].lat);
                                        const lng = parseFloat(data[0].lon);
                                        initMapWithCoords(lat, lng);
                                    } else {
                                        // Default to Ho Chi Minh City center
                                        initMapWithCoords(10.8231, 106.6297);
                                    }
                                });
                        }
                    })
                    .catch(error => {
                        console.error('Geocoding error:', error);
                        // Default to Ho Chi Minh City center
                        initMapWithCoords(10.8231, 106.6297);
                    });
            }
        });
    </script>
    {% endif %}
</body>
</html>