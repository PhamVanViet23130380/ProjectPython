{% load static %}
<!DOCTYPE html>
<html lang="vi" data-is-authenticated="{{ request.user.is_authenticated|yesno:'true,false' }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'app/css/header.css' %}">
    <link rel="stylesheet" href="{% static 'app/css/datphong.css' %}">
    <title>Yêu cầu đặt phòng/đặt chỗ - Home Nest</title>
</head>

<body data-listing-id="{{ listing_id }}">
    <!-- Simple Header -->
    <header class="booking-header">
        <div class="container">
            <div class="header-content">
                <a href="{% url 'home' %}" class="logo-link">
                    <a href="{% url 'home' %}">
                        <img src="{% static 'app/images/logo.jpg' %}" alt="Home Nest" class="header-logo">
                    </a>
                    <span class="header-title">
                        <span class="home-text">Home</span>
                        <span class="accent-text">Nest</span>
                    </span>
                </a>
            </div>
        </div>
    </header>

    <main class="booking-main">
        <script>
            // Expose authentication state to client JS so booking flow can redirect to login when needed
            window.__isAuthenticated = document.documentElement.dataset.isAuthenticated === "true";
            // Provide the named login URL for client-side redirects
            window.__loginUrl = "{% url 'login' %}";
        </script>
        <div class="container">
            <div class="booking-container">
                <!-- Left Side - Form -->
                <div class="booking-left">
                    <div class="back-row">
                        <button class="back-btn" onclick="window.history.back()">
                            <i class="fa-solid fa-arrow-left"></i>
                        </button>
                        <h1 class="booking-title">Yêu cầu đặt phòng</h1>
                    </div>

                    <!-- Trip Details -->
                    <section class="booking-section">
                        <h2 class="section-title">Chuyến đi của bạn</h2>
                        <div class="trip-details">
                            <div class="trip-item">
                                <div class="trip-label">Ngày</div>
                                <div class="trip-value">
                                    <span id="tripDates">16 - 18 tháng 1, 2026</span>
                                    <button class="edit-btn" id="editDatesBtn">Thay đổi</button>
                                </div>
                            </div>
                            <div class="trip-item">
                                <div class="trip-label">Khách</div>
                                <div class="trip-value">
                                    <span id="tripGuests">1 người lớn</span>
                                    <button class="edit-btn" id="editGuestsBtn">Thay đổi</button>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Date Picker Modal -->
                    <div class="modal-overlay" id="dateModal">
                        <div class="modal-container">
                            <div class="modal-header">
                                <h3>Thay đổi ngày</h3>
                                <button class="modal-close" onclick="closeDateModal()">×</button>
                            </div>
                            <div class="modal-body">
                                <div class="date-picker">
                                    <div class="date-input-group">
                                        <div class="date-input">
                                            <label>Nhận phòng</label>
                                            <input type="date" id="checkInDate" class="date-field">
                                        </div>
                                        <div class="date-input">
                                            <label>Trả phòng</label>
                                            <input type="date" id="checkOutDate" class="date-field">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn-secondary" onclick="closeDateModal()">Xóa ngày</button>
                                <button type="button" class="btn-primary" onclick="saveDates()">Lưu</button>
                            </div>
                        </div>
                    </div>

                    <!-- Guests Modal -->
                    <div class="modal-overlay" id="guestsModal">
                        <div class="modal-container">
                            <div class="modal-header">
                                <h3>Thay đổi khách</h3>
                                <button class="modal-close" onclick="closeGuestsModal()">×</button>
                            </div>
                            <div class="modal-body">
                                <p class="modal-description">Chỗ ở này cho phép tối đa 2 khách, không tính em bé. Không được phép mang theo thú cưng.</p>
                                
                                <div class="guest-counter">
                                    <div class="guest-item">
                                        <div>
                                            <div class="guest-label">Người lớn</div>
                                            <div class="guest-sublabel">Từ 13 tuổi trở lên</div>
                                        </div>
                                        <div class="counter-controls">
                                            <button class="counter-btn" onclick="decrementGuests('adults')">
                                                <i class="fa-solid fa-minus"></i>
                                            </button>
                                            <span class="counter-value" id="adultsCount">1</span>
                                            <button class="counter-btn" onclick="incrementGuests('adults')">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="guest-item">
                                        <div>
                                            <div class="guest-label">Trẻ em</div>
                                            <div class="guest-sublabel">Độ tuổi 2 – 12</div>
                                        </div>
                                        <div class="counter-controls">
                                            <button class="counter-btn" onclick="decrementGuests('children')">
                                                <i class="fa-solid fa-minus"></i>
                                            </button>
                                            <span class="counter-value" id="childrenCount">0</span>
                                            <button class="counter-btn" onclick="incrementGuests('children')">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="guest-item">
                                        <div>
                                            <div class="guest-label">Em bé</div>
                                            <div class="guest-sublabel">Dưới 2 tuổi</div>
                                        </div>
                                        <div class="counter-controls">
                                            <button class="counter-btn" onclick="decrementGuests('infants')">
                                                <i class="fa-solid fa-minus"></i>
                                            </button>
                                            <span class="counter-value" id="infantsCount">0</span>
                                            <button class="counter-btn" onclick="incrementGuests('infants')">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="guest-item">
                                        <div>
                                            <div class="guest-label">Thú cưng</div>
                                            <div class="guest-sublabel">Bạn sẽ mang theo động vật phục vụ?</div>
                                        </div>
                                        <div class="counter-controls">
                                            <button class="counter-btn" onclick="decrementGuests('pets')">
                                                <i class="fa-solid fa-minus"></i>
                                            </button>
                                            <span class="counter-value" id="petsCount">0</span>
                                            <button class="counter-btn" onclick="incrementGuests('pets')">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn-secondary" onclick="closeGuestsModal()">Hủy</button>
                                <button type="button" class="btn-primary" onclick="saveGuests()">Lưu</button>
                            </div>
                        </div>
                    </div>

                                                                                                    <!-- Payment Method -->
                    <section class="booking-section collapsible-section">
                        <div class="section-header" data-toggle="collapse">
                            <h2 class="section-title">1. Thêm phương thức thanh toán</h2>
                            <i class="fa-solid fa-chevron-down toggle-icon"></i>
                        </div>
                        
                        <div class="section-content collapsed">
                            <div class="payment-options">
                                <label class="payment-option">
                                    <input type="radio" name="payment_type" value="card" checked>
                                    <div class="payment-content">
                                        <div class="payment-icons">
                                            <i class="fa-brands fa-cc-visa"></i>
                                            <i class="fa-brands fa-cc-mastercard"></i>
                                        </div>
                                        <span>Thẻ tín dụng hoặc thẻ ghi nợ</span>
                                    </div>
                                </label>
                                <label class="payment-option">
                                    <input type="radio" name="payment_type" value="vnpay">
                                    <div class="payment-content">
                                        <div class="payment-icons">
                                            <span class="fw-bold">VNPay</span>
                                        </div>
                                        <span>Thanh toán qua VNPay (sandbox)</span>
                                    </div>
                                </label>
                            </div>

                            <form class="payment-form" id="paymentForm">
                                <div class="form-group">
                                    <label for="cardNumber">Số thẻ <i class="fa-solid fa-lock"></i></label>
                                    <input type="text" id="cardNumber" class="form-control" 
                                           placeholder="1234 5678 9012 3456" 
                                           maxlength="19" required>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                    <label for="expiryDate">Ngày hết hạn</label>
                                        <input type="text" id="expiryDate" class="form-control" 
                                               placeholder="MM/YY" maxlength="5" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="cvv">CVV</label>
                                        <input type="text" id="cvv" class="form-control" 
                                               placeholder="123" maxlength="3" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="postalCode">Mã bưu chính</label>
                                    <input type="text" id="postalCode" class="form-control" 
                                           placeholder="Nhập mã bưu chính" required>
                                </div>

                                <div class="form-group">
                                    <label for="country">Quốc gia/khu vực</label>
                                    <select id="country" class="form-control" required>
                                        <option value="VN">Việt Nam</option>
                                        <option value="US">United States</option>
                                        <option value="UK">United Kingdom</option>
                                        <option value="JP">Japan</option>
                                        <option value="KR">South Korea</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                    </section>

<!-- Message to Host -->
                    <section class="booking-section collapsible-section">
                        <div class="section-header" data-toggle="collapse">
                            <h2 class="section-title">2. Nhắn tin cho host</h2>
                            <i class="fa-solid fa-chevron-down toggle-icon"></i>
                        </div>
                        
                        <div class="section-content collapsed">
                            <div class="message-host-content">
                                <p class="message-description">Cho host biết lý do bạn đi và ai sẽ tham gia cùng bạn.</p>
                                <div class="form-group">
                                    <textarea id="hostMessage" name="note" class="form-control" rows="5" 
                                              placeholder="Xin chào! Tôi rất mong chờ được ở chỗ của bạn. Tôi sẽ đến với..."></textarea>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Review Request -->
                    <section class="booking-section collapsible-section">
                        <div class="section-header" data-toggle="collapse">
                            <h2 class="section-title">3. Xem lại yêu cầu của bạn</h2>
                            <i class="fa-solid fa-chevron-down toggle-icon"></i>
                        </div>
                        
                        <div class="section-content collapsed">
                            <div class="review-content">
                                <div class="review-item">
                                    <div class="review-label">
                                        <i class="fa-solid fa-calendar"></i>
                                        <span>Ngày</span>
                                    </div>
                                    <div class="review-value" id="reviewDates">16 - 18 tháng 1, 2026</div>
                                </div>
                                <div class="review-item">
                                    <div class="review-label">
                                        <i class="fa-solid fa-user"></i>
                                        <span>Khách</span>
                                    </div>
                                    <div class="review-value" id="reviewGuests">1 người lớn</div>
                                </div>
                                <div class="review-item">
                                    <div class="review-label">
                                        <i class="fa-solid fa-door-open"></i>
                                        <span>Nhận phòng</span>
                                    </div>
                                    <div class="review-value">Sau 14:00</div>
                                </div>
                                <div class="review-item">
                                    <div class="review-label">
                                        <i class="fa-solid fa-door-closed"></i>
                                        <span>Trả phòng</span>
                                    </div>
                                    <div class="review-value">Trước 12:00</div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Cancellation Policy -->
                    <section class="booking-section">
                        <h2 class="section-title">Chính sách hủy</h2>
                        <div class="policy-info">
                            <p class="policy-text">
                                <strong>Hủy miễn phí</strong> Hủy trước 11 tháng 1 để được hoàn tiền đầy đủ.
                            </p>
                            <a href="#" class="policy-link">Toàn bộ chính sách <i class="fa-solid fa-chevron-right"></i></a>
                        </div>
                    </section>

                    <!-- Ground Rules -->
                    <section class="booking-section">
                        <h2 class="section-title">Quy chuẩn chung</h2>
                        <div class="rules-text">
                            <p>Chúng tôi yêu cầu tất cả khách ghi nhớ một số quy tắc đơn giản để trở thành vị khách tuyệt vời.</p>
                            <ul>
                                <li>Tuân thủ nội quy nhà</li>
                                <li>Đối xử với chỗ ở của Chủ nhà như thể đó là nhà của bạn</li>
                            </ul>
                        </div>
                    </section>

                    <!-- Terms -->
                    <section class="booking-section">
                        <p class="terms-text">
                            Bằng việc chọn nút dưới đây, tôi đồng ý với 
                            <a href="#">Nội quy nhà của Chủ nhà</a>, 
                            <a href="#">Quy chuẩn chung</a> của Home Nest dành cho khách, và 
                            <a href="#">Chính sách Đặt lại và Hoàn tiền</a> của Home Nest. 
                            Tôi cũng đồng ý trả tiền cho Home Nest nếu tôi phải chịu trách nhiệm về thiệt hại.
                        </p>
                    </section>

                    <!-- Submit Button -->
                    <button class="submit-btn" id="submitBooking">
                        Xác nhận và thanh toán
                    </button>
                </div>

                <!-- Right Side - Booking Summary -->
                <div class="booking-right">
                    <div class="booking-card">
                        <div class="room-info">
                            <img src="{{ image_url }}" alt="{{ title }}" class="room-image" id="roomImage" onerror="this.onerror=null; this.src='https://via.placeholder.com/200x150?text=No+Image'">
                            <div class="room-details">
                                <h3 class="room-title" id="roomTitle">{{ title }}</h3>
                                <div class="room-rating">
                                    <i class="fa-solid fa-star"></i>
                                    <span id="roomRating">{{ rating }}</span>
                                    <span class="rating-count" id="roomReviews">({{ review_count }} đánh giá)</span>
                                </div>
                            </div>
                        </div>

                        <hr class="divider">

                        <div class="price-details">
                            <h4 class="price-title">Chi tiết giá</h4>
                            
                            <div class="price-row">
                                <span class="price-label">
                                    <span id="pricePerNight">₫{{ price_per_night|floatformat:0 }}</span> x <span id="numNights">2</span> đêm
                                </span>
                                <span class="price-value" id="subtotal">₫0</span>
                            </div>

                            <!-- Phí vệ sinh (nếu có) -->

                            <!-- Phí khách thêm (nếu có) -->

                            <!-- Phí cuối tuần (nếu có) -->

                        </div>

                        <hr class="divider">

                        <div class="price-row total-row">
                            <span class="price-label"><strong>Tổng cộng (VND)</strong></span>
                            <span class="price-value"><strong id="totalPrice">₫0</strong></span>
                        </div>
                    </div>

                    <!-- Trust Info -->
                    <div class="trust-info">
                        <div class="trust-item">
                            <i class="fa-solid fa-shield-halved"></i>
                            <div class="trust-text">
                                <strong>Thông tin của bạn được bảo mật</strong>
                                <p>Chúng tôi sử dụng mã hóa để bảo vệ thông tin thanh toán của bạn.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Confirmation Modal (shown after payment validation passes) -->
    <div class="modal-overlay" id="confirmBookingModal" style="display:none;">
        <div class="modal-container confirm-modal">
            <div class="modal-header">
                <h3 id="confirmRoomTitle">Xác nhận đặt phòng</h3>
                <button class="modal-close" id="confirmModalClose">×</button>
            </div>
            <div class="modal-body confirm-body">
                <div class="confirm-left">
                    <img id="confirmRoomImage" src="" alt="Room image" />
                </div>
                <div class="confirm-right">
                    <div class="confirm-row"><strong>Chỗ ở:</strong> <span id="confirmRoomTitleText"></span></div>
                    <div class="confirm-row"><strong>Ngày:</strong> <span id="confirmDates"></span></div>
                    <div class="confirm-row"><strong>Khách:</strong> <span id="confirmGuests"></span></div>
                    <hr />
                    <div class="confirm-row"><span>Tiền phòng</span><span id="confirmSubtotal"></span></div>
                    <div class="confirm-row total"><strong>Tổng cộng</strong><strong id="confirmTotalPrice"></strong></div>
                    <div id="confirmErrorMsg" style="display:none;color:#b00020;margin-top:8px;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelPayBtn">Hủy</button>
                <button class="btn-primary" id="confirmPayBtn">Thanh to&#225;n</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js"></script>
    <script src="{% static 'app/js/datphong_api.js' %}?v=14"></script>
    <script src="{% static 'app/js/datphong.js' %}?v=17"></script>
    
    {% include 'app/includes/chat_widget.html' %}
</body>

</html>
