{% extends 'app/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/profile.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="container">
    <nav style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
        <a href="{% url 'home' %}" class="logo"><i class="fas fa-home"></i> Trang chủ</a>
        {% if request.user.is_authenticated %}
            <div style="display:flex;align-items:center;gap:8px;">
                <img src="{{ request.user.avatar_url|default:'https://i.pinimg.com/736x/ed/57/43/ed574383727c119220c3934c79a191fb.jpg' }}" width="36" alt="Avatar" style="border-radius:50%;">
                <span>{{ request.user.get_full_name|default:request.user.username }}</span>
            </div>
        {% endif %}
    </nav>

    <div class="profile-layout">
        <nav class="tabs">
            <button class="tab-item active">Thông tin tài khoản</button>
            <button class="tab-item">Lịch sử thuê nhà</button>
            <button class="tab-item">Tin nhắn</button>
            <button class="tab-item">Yêu thích</button>
        </nav>

        <main class="profile-content">
            <aside class="sidebar">
                <div class="profile-card">
                    <div class="avatar-container">
                        <img src="{{ profile_user.avatar_url|default:'https://i.pinimg.com/736x/ed/57/43/ed574383727c119220c3934c79a191fb.jpg' }}" alt="User Avatar" class="main-avatar">
                    </div>
                    <h3>Xin chào, {{ profile_user.full_name|default:profile_user.username }}!</h3>
                    <ul class="info-list">
                        <li><i class="fas fa-envelope"></i> {{ profile_user.email }}</li>
                        <li><i class="fas fa-phone"></i> {{ profile_user.phone_number|default:'Chưa cập nhật số điện thoại' }}</li>
                        <li><i class="fas fa-user-tag"></i> Vai trò: {{ profile_user.role|default:'Khách' }}</li>
                    </ul>
                    {% comment %}
                    {% if request.user.is_authenticated and request.user.id == profile_user.id %}
                        <a href="{% url 'profile_edit' %}" class="btn-edit">Chỉnh sửa hồ sơ</a>
                    {% endif %}
                    {% endcomment %}
                </div>
            </aside>

            <section class="history-section">
                <h2>Lịch sử thuê nhà</h2>

                {% if bookings %}
                    {% for booking in bookings %}
                        <div class="history-item" style="padding: 20px; margin-bottom: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; display: flex; gap: 16px;">
                            <img src="{{ booking.listing_image }}" alt="{{ booking.listing.title }}" style="width: 120px; height: 90px; border-radius: 8px; object-fit: cover;" onerror="this.onerror=null; this.src='https://via.placeholder.com/120x90?text=No+Image'">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600;">{{ booking.listing.title }}</h4>
                                <span class="status" style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; 
                                    {% if booking.booking_status == 'confirmed' %}background: #e8f5e9; color: #2e7d32;
                                    {% elif booking.booking_status == 'pending' %}background: #fff3e0; color: #f57c00;
                                    {% else %}background: #ffebee; color: #c62828;{% endif %}">
                                    {% if booking.booking_status == 'confirmed' %}Đã xác nhận
                                    {% elif booking.booking_status == 'pending' %}Chờ xác nhận
                                    {% else %}Đã hủy{% endif %}
                                </span>
                                <div style="margin-top: 8px; color: #717171; font-size: 14px;">
                                    <p style="margin: 4px 0;"><i class="fas fa-calendar"></i> {{ booking.check_in|date:"d/m/Y" }} — {{ booking.check_out|date:"d/m/Y" }}</p>
                                    <p style="margin: 4px 0;"><i class="fas fa-users"></i> {{ booking.guests }} khách • <i class="fas fa-moon"></i> {{ booking.nights }} đêm</p>
                                    <p style="margin: 4px 0; font-size: 16px; font-weight: 600; color: #222;">₫{{ booking.total_price|floatformat:0 }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 40px; background: #f7f7f7; border-radius: 8px;">
                        <i class="fas fa-calendar-xmark" style="font-size: 48px; color: #ddd; margin-bottom: 12px;"></i>
                        <p style="color: #717171; margin: 0;">Bạn chưa có lịch sử thuê nhà nào.</p>
                    </div>
                {% endif %}

            </section>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleDropdown() {
        const dropdown = document.getElementById('userDropdown');
        if (!dropdown) return;
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    window.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        if (!dropdown) return;
        if (!event.target.closest('.fa-chevron-down')) {
            if (dropdown.style.display === 'block') dropdown.style.display = 'none';
        }
    });
</script>
{% endblock %}
