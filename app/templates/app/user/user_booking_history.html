{% extends 'app/base.html' %}
{% load static %}
{% load formatting %}

{% block title %}Lịch sử thuê nhà - Home Nest{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'app/css/user_booking_history.css' %}">
{% endblock %}

{% block content %}
<div class="booking-history-container">
    <div class="profile-tabs">
        <a href="{% url 'user_booking_history' %}" class="profile-tab active">
            <i class="fa-solid fa-calendar-days"></i> Lịch sử đặt nhà
        </a>
    </div>
    <h1 class="page-title">Lịch sử thuê nhà</h1>
    
    <!-- Filter Toggle -->
    <div class="filter-toggle">
        <a href="{% url 'user_booking_history' %}" class="toggle-btn {% if filter_type == 'active' or not filter_type %}active{% endif %}">
            <i class="fa-solid fa-circle-check"></i> Đang hoạt động
        </a>
        <a href="{% url 'user_booking_history' %}?filter=cancelled" class="toggle-btn {% if filter_type == 'cancelled' %}active{% endif %}">
            <i class="fa-solid fa-circle-xmark"></i> Đã hủy
        </a>
        <a href="{% url 'user_booking_history' %}?filter=all" class="toggle-btn {% if filter_type == 'all' %}active{% endif %}">
            <i class="fa-solid fa-list"></i> Tất cả
        </a>
    </div>
    
    {% if bookings %}
        {% for booking in bookings %}
        <div class="booking-card">
            <img src="{{ booking.listing.main_image }}" alt="{{ booking.listing.title }}" class="booking-image" onerror="this.onerror=null; this.src='https://via.placeholder.com/200x150?text=No+Image'">
            
            <div class="booking-details">
                <h3 class="listing-title">{{ booking.listing.title }}</h3>
                
                <span class="booking-status {% if booking.booking_status == 'confirmed' %}status-confirmed{% elif booking.booking_status == 'pending' %}status-pending{% elif booking.booking_status == 'in_progress' %}status-confirmed{% elif booking.booking_status == 'completed' %}status-confirmed{% else %}status-cancelled{% endif %}">
                    {% if booking.booking_status == 'confirmed' %}
                        Đã xác nhận
                    {% elif booking.booking_status == 'pending' %}
                        Chờ xác nhận
                    {% elif booking.booking_status == 'in_progress' %}
                        Đang ở
                    {% elif booking.booking_status == 'completed' %}
                        Hoàn thành
                    {% else %}
                        Đã hủy
                    {% endif %}
                </span>
                
                <div class="booking-info">
                    <div class="info-item">
                        <i class="fa-solid fa-calendar"></i>
                        <span>Nhận phòng: {{ booking.check_in|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-calendar"></i>
                        <span>Trả phòng: {{ booking.check_out|date:"d/m/Y" }}</span>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-users"></i>
                        <span>{{ booking.guests }} khách</span>
                    </div>
                    <div class="info-item">
                        <i class="fa-solid fa-moon"></i>
                        <span>{{ booking.nights }} đêm</span>
                    </div>
                </div>
                
                <!-- Nút hành động -->
                {% if booking.booking_status == 'pending' or booking.booking_status == 'confirmed' %}
                <div class="booking-actions">
                    <a href="{% url 'booking_success' booking.booking_id %}" class="btn-view">
                        <i class="fa-solid fa-eye"></i> Xem chi tiết
                    </a>
                    <form method="post" action="{% url 'cancel_booking' booking.booking_id %}" style="display: inline-block;">
                        {% csrf_token %}
                        <button type="button" class="btn-cancel cancel-booking-btn" data-booking-id="{{ booking.booking_id }}" data-listing-title="{{ booking.listing.title|escapejs }}">
                            <i class="fa-solid fa-xmark"></i> Hủy đặt phòng
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="booking-actions">
                    <a href="{% url 'booking_success' booking.booking_id %}" class="btn-view">
                        <i class="fa-solid fa-eye"></i> Xem chi tiết
                    </a>
                </div>
                {% endif %}
            </div>
            
            <div class="booking-price">
                <div class="price-amount">đ{{ booking.total_price|floatformat:0|intdot }}</div>
                <small style="color: #717171;">Tổng tiền</small>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fa-solid fa-calendar-xmark"></i>
            </div>
            {% if filter_type == 'cancelled' %}
                <h2 class="empty-title">Chưa có đơn hủy nào</h2>
                <p class="empty-text">Bạn chưa hủy bất kỳ đặt phòng nào. Tất cả các đơn của bạn đang hoạt động!</p>
            {% elif filter_type == 'all' %}
                <h2 class="empty-title">Chưa có lịch sử thuê nhà</h2>
                <p class="empty-text">Bạn chưa đặt phòng nào. Hãy khám phá các chỗ ở tuyệt vời của chúng tôi!</p>
            {% else %}
                <h2 class="empty-title">Không có đơn đang hoạt động</h2>
                <p class="empty-text">Bạn không có đặt phòng nào đang hoạt động. {% if cancelled_count > 0 %}Bạn có {{ cancelled_count }} đơn đã hủy.{% endif %}</p>
            {% endif %}
            <a href="{% url 'home' %}" class="btn-explore">
                <i class="fa-solid fa-magnifying-glass"></i> Khám phá ngay
            </a>
        </div>
    {% endif %}
</div>

<!-- Custom Cancel Modal -->
<div class="modal-overlay" id="cancelModal">
    <div class="modal-content">
        <div class="modal-icon">
            <i class="fa-solid fa-circle-exclamation"></i>
        </div>
        <h2 class="modal-title">Xác nhận hủy đặt phòng</h2>
        <p class="modal-text">
            Bạn có chắc chắn muốn hủy đặt phòng "<span id="listingTitle"></span>" không?<br>
            <small style="color: #999; font-size: 14px; margin-top: 8px; display: block;">Hành động này không thể hoàn tác.</small>
        </p>
        <div class="modal-actions">
            <button type="button" class="modal-btn modal-btn-back" onclick="closeCancelModal()">
                <i class="fa-solid fa-arrow-left"></i> Quay lại
            </button>
            <form method="post" id="cancelForm" style="flex: 1;">
                {% csrf_token %}
                <button type="submit" class="modal-btn modal-btn-cancel-action">
                    <i class="fa-solid fa-check"></i> Xác nhận hủy
                </button>
            </form>
        </div>
    </div>
</div>

<script>
// Attach event listeners to all cancel buttons
document.addEventListener('DOMContentLoaded', function() {
    const cancelButtons = document.querySelectorAll('.cancel-booking-btn');
    cancelButtons.forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const bookingId = this.getAttribute('data-booking-id');
            const listingTitle = this.getAttribute('data-listing-title');
            showCancelModal(bookingId, listingTitle);
        });
    });

    const modal = document.getElementById('cancelModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeCancelModal();
            }
        });
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCancelModal();
        }
    });
});

function showCancelModal(bookingId, listingTitle) {
    const modal = document.getElementById('cancelModal');
    const form = document.getElementById('cancelForm');
    const titleElement = document.getElementById('listingTitle');

    if (!modal || !form || !titleElement) {
        return;
    }

    form.action = '/booking/cancel/' + bookingId + '/';
    titleElement.textContent = listingTitle;

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeCancelModal() {
    const modal = document.getElementById('cancelModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}
</script>
{% endblock %}
